hooks:
  script:
    success:
      - run: |
          ## TODO: use the correct owner as defined in jreleaser - https://github.com/jreleaser/jreleaser/issues/1937 
          container-structure-test test --image docker.io/jbangdev/jbang-action:{{tagName}} --config src/jreleaser/distributions/jbang/docker/container-structure-test.yaml
        verbose: true
        # disabled as org/username locally will not be jbangdev
        condition: '"{{ Env.CONTAINER_STRUCTURE_TEST }}" == true'
        filter:
          includes: ['package']

project:
  name: jbang
  description: Unleash the power of Java
  longDescription: |
    Unleash the power of Java.
    Use `jbang` to run java, jar, jsh or kt file(s) with automatic dependency fetching
    and immediate compilation and execution.
  links:
    homepage: https://jbang.dev
    documentation: https://jbang.dev/documentation
    license: https://github.com/jbangdev/jbang/blob/main/LICENSE
  authors:
    - Max Rydahl Andersen
    - Tako Schotanus
  license: MIT
  tags:
    - jbang
    - bash
    - java
    - shell
    - scripting
  java:
    groupId: dev.jbang
    version: 8
  inceptionYear: 2020
  stereotype: CLI

release:
  github:
    overwrite: true
    draft: true
    sign: true
    releaseName: '{{tagName}}'
    skipTag: true
    milestone:
      close: false
    changelog:
      formatted: always
      preset: "conventional-commits"
      format: '- {{commitShortHash}} {{commitTitle}}'

checksum:
  individual: true

signing:
  active: ALWAYS
  armored: true

deploy:
  maven:
    mavenCentral:
      jbang:
        # workaround jreleaser bug around maven central credentials
        username: "Vjuu+gNF"
        active: ALWAYS
        url: https://central.sonatype.com/api/v1/publisher
        applyMavenCentralRules: true
        authorization: BEARER
        stagingRepositories:
          - build/staging-deploy

announce:
  bluesky:
    active: RELEASE
    status: 'JBang {{projectVersion}} has been released! {{releaseNotesUrl}}'
    handle: 'jbang.dev'
    host: https://bsky.social
  sdkman:
    active: RELEASE
  article:
    active: RELEASE
    repository:
      name: jbang.dev
    files:
      - path: 'blogpost.adoc'
        transform: 'content/posts/{{projectName}}-{{#f_dash}}{{projectVersion}}{{/f_dash}}-released.adoc'

files:
  artifacts:
    - path: build/tmp/version.txt
    - path: build/distributions/jbang.zip
    - path: build/distributions/jbang.tar

distributions:
  jbang:
    extraProperties:
      # Key will be capitalized and prefixed with `distribution`, i.e, `distributionFoo`.
      # Used to trigger only specific multi docker builds
      distro: jbang-container
    executable:
      windowsExtension: cmd
    docker: 
      active: RELEASE
      continueOnError: true
      repository:
        name: jbang-container
      registries:
        - serverName: quay.io
          externalLogin: true
        - serverName: docker.io
          externalLogin: true
        - serverName: ghcr.io
          externalLogin: true
      specs:
        java-8:
          baseImage: "eclipse-temurin:8"          
          templateDirectory: src/jreleaser/distributions/jbang/docker/java
          imageNames:
            - 'jbangdev/jbang:{{projectVersion}}-{{dockerSpecName}}'
          matchers:
            distro: jbang-container
        java-11:
          baseImage: "eclipse-temurin:11"          
          templateDirectory: src/jreleaser/distributions/jbang/docker/java
          imageNames:
            - 'jbangdev/jbang:{{projectVersion}}-{{dockerSpecName}}'
          matchers:
            distro: jbang-container
        java-17:
          baseImage: "eclipse-temurin:17"
          templateDirectory: src/jreleaser/distributions/jbang/docker/java
          imageNames:
            - 'jbangdev/jbang:{{projectVersion}}-{{dockerSpecName}}'
          matchers:
            distro: jbang-container
        java-21:
          baseImage: "eclipse-temurin:21"
          templateDirectory: src/jreleaser/distributions/jbang/docker/java
          imageNames:
            - 'jbangdev/jbang:{{projectVersion}}-{{dockerSpecName}}'
            - 'jbangdev/jbang:{{projectVersion}}'
            - 'jbangdev/jbang:latest'
          matchers:
            distro: jbang-container
        #java-24:
        #  baseImage: "eclipse-temurin:24"
        #  templateDirectory: src/jreleaser/distributions/jbang/docker
        #  imageNames:
        #    - 'jbangdev/jbang:{{tagName}}-{{dockerSpecName}}'
        #  matchers:
        #    distro: jbang-container
    sdkman:
      active: RELEASE
      continueOnError: true
    brew:
      active: RELEASE
      continueOnError: true
      extraProperties:
        skipJava: true
    scoop:
      active: RELEASE
      continueOnError: true
      bucket:
        name: 'scoop-bucket'
    chocolatey:
      active: RELEASE
      continueOnError: true
      remoteBuild: true
      title: JBang
    snap:
      active: RELEASE
      continueOnError: true
      remoteBuild: true
      base: core18
      confinement: classic
    artifacts:
      - path: build/distributions/jbang-{{projectVersion}}.zip
      - path: build/distributions/jbang-{{projectVersion}}.tar
  jbang-action:
    docker:  
      active: RELEASE
      continueOnError: true
      baseImage: "eclipse-temurin:11"
      repository:
        name: jbang-action
      imageNames:
        - "{{repoOwner}}/{{distributionName}}:{{projectVersion}}"
        - "{{repoOwner}}/{{distributionName}}:latest"
      registries:
        - serverName: quay.io
          externalLogin: true
        - serverName: docker.io
          externalLogin: true
        - serverName: ghcr.io
          externalLogin: true
    artifacts:
      - path: build/distributions/jbang-{{projectVersion}}.zip
      - path: build/distributions/jbang-{{projectVersion}}.tar
    
